
<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="UTF-8">
    <title>Network Rules Generator</title>
    <style>
      /* ... keep existing code (styles) */
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Network Rules Generator</h1>
      
      <div class="info-box">
        Ces trois champs sont obligatoires, vous ne pouvez pas commencer à les saisir sans les avoir remplis.
      </div>

      <div class="mandatory">
        <div class="form-group">
          <label>Department <span class="required">*</span></label>
          <input type="text" id="department" placeholder="Department (1-4 chars)" maxlength="4">
        </div>
        <div class="form-group">
          <label>Project/Application Code <span class="required">*</span></label>
          <input type="text" id="projectCode" placeholder="Project code (1-4 chars)" maxlength="4">
        </div>
        <div class="form-group">
          <label>Requester's Email <span class="required">*</span></label>
          <input type="email" id="email" placeholder="Email address">
        </div>
      </div>

      <div id="rulesContainer">
        <div class="rules-grid" id="rule-1">
          <div>
            <label>Source IP</label>
            <input type="text" class="sourceIP" placeholder="IP source">
          </div>
          <div>
            <label>IP Destination</label>
            <input type="text" class="destIP" placeholder="IP destination">
          </div>
          <div>
            <label>Protocole</label>
            <select class="protocol">
              <option value="tcp">TCP</option>
              <option value="udp">UDP</option>
              <option value="icmp">ICMP</option>
            </select>
          </div>
          <div>
            <label>Service</label>
            <input type="text" class="service" placeholder="Service">
          </div>
          <div>
            <label>Port</label>
            <input type="number" class="port" placeholder="Port">
          </div>
          <div>
            <label>Authentication</label>
            <select class="authentication">
              <option value="none">Select</option>
              <option value="basic">Basic</option>
              <option value="oauth">OAuth</option>
            </select>
          </div>
          <div>
            <label>Flow encryption</label>
            <select class="encryption">
              <option value="none">Select</option>
              <option value="ssl">SSL/TLS</option>
              <option value="ipsec">IPSec</option>
            </select>
          </div>
          <div>
            <label>Classification</label>
            <select class="classification">
              <option value="public">Select</option>
              <option value="internal">Internal</option>
              <option value="confidential">Confidential</option>
            </select>
          </div>
          <div>
            <label>APP code</label>
            <input type="text" class="appCode" placeholder="Code (4 chars)" maxlength="4">
          </div>
          <button class="add-button" onclick="addNewRule()">+</button>
        </div>
      </div>

      <div class="action-buttons">
        <button class="btn btn-delete" onclick="deleteRules()">Delete</button>
        <button class="btn btn-resume" onclick="resumeDraft()">Resume Draft</button>
        <button class="btn btn-verify" onclick="verifyRules()">Verify</button>
        <button class="btn btn-validate" onclick="validateRules()">Validate</button>
        <button onclick="generateScripts()" class="btn btn-generate">Generate Scripts</button>
      </div>

      <div id="output" class="output">
        <h3>Generated Scripts</h3>
        <div id="scripts-container"></div>
      </div>
    </div>

    <script>
      let ruleCount = 1;

      function validateIP(ip) {
        const ipPattern = /^(\d{1,3}\.){3}\d{1,3}$/;
        return ipPattern.test(ip);
      }

      function validatePort(port) {
        return port > 0 && port < 65536;
      }

      function addNewRule() {
        if (ruleCount >= 5) {
          alert('Maximum 5 rules allowed');
          return;
        }
        
        ruleCount++;
        const container = document.getElementById('rulesContainer');
        const newRule = document.querySelector('.rules-grid').cloneNode(true);
        newRule.id = 'rule-' + ruleCount;
        
        // Clear inputs in the new rule
        newRule.querySelectorAll('input').forEach(input => input.value = '');
        newRule.querySelectorAll('select').forEach(select => select.selectedIndex = 0);
        
        container.appendChild(newRule);
      }

      function generateScripts() {
        const mandatory = {
          department: document.getElementById('department').value,
          projectCode: document.getElementById('projectCode').value,
          email: document.getElementById('email').value
        };

        if (!mandatory.department || !mandatory.projectCode || !mandatory.email) {
          alert('Veuillez remplir tous les champs obligatoires');
          return;
        }

        const rules = [];
        document.querySelectorAll('.rules-grid').forEach((rule, index) => {
          const formData = {
            sourceIP: rule.querySelector('.sourceIP').value,
            destIP: rule.querySelector('.destIP').value,
            protocol: rule.querySelector('.protocol').value,
            service: rule.querySelector('.service').value,
            port: rule.querySelector('.port').value,
            authentication: rule.querySelector('.authentication').value,
            encryption: rule.querySelector('.encryption').value,
            classification: rule.querySelector('.classification').value,
            appCode: rule.querySelector('.appCode').value
          };

          if (formData.sourceIP && formData.destIP && formData.service && formData.port) {
            if (!validateIP(formData.sourceIP) || !validateIP(formData.destIP)) {
              alert(`Règle ${index + 1}: Format IP invalide`);
              return;
            }
            if (!validatePort(formData.port)) {
              alert(`Règle ${index + 1}: Port invalide`);
              return;
            }
            rules.push(formData);
          }
        });

        if (rules.length === 0) {
          alert('Aucune règle valide à générer');
          return;
        }

        const scriptsContainer = document.getElementById('scripts-container');
        scriptsContainer.innerHTML = '';

        rules.forEach((rule, index) => {
          google.script.run
            .withSuccessHandler(function(scriptContent) {
              const scriptDiv = document.createElement('div');
              scriptDiv.className = 'script-block';
              scriptDiv.innerHTML = `
                <div class="script-header">
                  <strong>ID: ${index + 1}</strong>
                  <button onclick="copyScript(this)" class="btn">Copy</button>
                </div>
                <textarea readonly class="script-output">${scriptContent}</textarea>
              `;
              scriptsContainer.appendChild(scriptDiv);

              // Save to sheet
              google.script.run.withSuccessHandler(function(response) {
                if (!response.success) {
                  alert('Erreur lors de la sauvegarde: ' + response.message);
                }
              }).saveToSheet({
                ...mandatory,
                script: scriptContent,
                rowIndex: index + 1
              });
            })
            .generateScript(rule);
        });

        document.getElementById('output').style.display = 'block';
      }

      function copyScript(button) {
        const textarea = button.parentElement.nextElementSibling;
        textarea.select();
        document.execCommand('copy');
        alert('Script copié dans le presse-papier');
      }

      function deleteRules() {
        if (confirm('Voulez-vous vraiment supprimer toutes les règles ?')) {
          const container = document.getElementById('rulesContainer');
          while (container.children.length > 1) {
            container.removeChild(container.lastChild);
          }
          document.querySelectorAll('input').forEach(input => input.value = '');
          document.querySelectorAll('select').forEach(select => select.selectedIndex = 0);
          document.getElementById('output').style.display = 'none';
          ruleCount = 1;
        }
      }

      // Fonctions à implémenter plus tard si nécessaire
      function resumeDraft() {
        alert('Fonction à implémenter');
      }

      function verifyRules() {
        alert('Fonction à implémenter');
      }

      function validateRules() {
        alert('Fonction à implémenter');
      }
    </script>
  </body>
</html>
