<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="UTF-8">
    <title>Network Rules Generator</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background-color: #f5f5f5;
      }
      
      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }

      h1 {
        color: #333;
        margin-bottom: 20px;
      }

      .info-box {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 4px;
        color: #495057;
      }

      .mandatory {
        margin-bottom: 30px;
      }

      .form-group {
        margin-bottom: 15px;
      }

      label {
        display: block;
        margin-bottom: 5px;
        color: #495057;
      }

      .required {
        color: red;
      }

      input[type="text"],
      input[type="email"],
      input[type="number"],
      select {
        width: 100%;
        padding: 8px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        box-sizing: border-box;
        margin-bottom: 10px;
      }

      .rules-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
        padding: 15px;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        background-color: #f8f9fa;
      }

      .add-button {
        background-color: #28a745;
        color: white;
        border: none;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        font-size: 20px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-top: 10px;
      }

      .add-button:hover {
        background-color: #218838;
      }

      .action-buttons {
        margin-top: 20px;
        display: flex;
        gap: 10px;
      }

      .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: background-color 0.2s;
      }

      .btn-delete {
        background-color: #dc3545;
        color: white;
      }

      .btn-delete:hover {
        background-color: #c82333;
      }

      .btn-resume {
        background-color: #17a2b8;
        color: white;
      }

      .btn-resume:hover {
        background-color: #138496;
      }

      .btn-verify {
        background-color: #ffc107;
        color: #212529;
      }

      .btn-verify:hover {
        background-color: #e0a800;
      }

      .btn-validate {
        background-color: #28a745;
        color: white;
      }

      .btn-validate:hover {
        background-color: #218838;
      }

      .btn-generate {
        background-color: #007bff;
        color: white;
      }

      .btn-generate:hover {
        background-color: #0056b3;
      }

      .output {
        margin-top: 30px;
        display: none;
      }

      .script-block {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        margin-bottom: 15px;
        padding: 15px;
      }

      .script-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }

      .script-output {
        width: 100%;
        height: 150px;
        padding: 10px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        background-color: #fff;
        font-family: monospace;
        resize: vertical;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Network Rules Generator</h1>
      
      <div class="action-buttons" style="margin-bottom: 20px;">
        <button class="btn btn-primary" onclick="importCSVFile()">Importer CSV</button>
        <input type="file" id="csvFileInput" accept=".csv" style="display: none;" onchange="handleCSVFile(this)">
      </div>
      
      <div class="info-box">
        Ces trois champs sont obligatoires, vous ne pouvez pas commencer à les saisir sans les avoir remplis.
      </div>

      <div class="mandatory">
        <div class="form-group">
          <label>Department <span class="required">*</span></label>
          <input type="text" id="department" placeholder="Department (1-4 chars)" maxlength="4">
        </div>
        <div class="form-group">
          <label>Project/Application Code <span class="required">*</span></label>
          <input type="text" id="projectCode" placeholder="Project code (1-4 chars)" maxlength="4">
        </div>
        <div class="form-group">
          <label>Requester's Email <span class="required">*</span></label>
          <input type="email" id="email" placeholder="Email address">
        </div>
      </div>

      <div id="rulesContainer">
        <div class="rules-grid" id="rule-1">
          <div>
            <label>Source IP</label>
            <input type="text" class="sourceIP" placeholder="IP source">
          </div>
          <div>
            <label>IP Destination</label>
            <input type="text" class="destIP" placeholder="IP destination">
          </div>
          <div>
            <label>Protocole</label>
            <select class="protocol">
              <option value="tcp">TCP</option>
              <option value="udp">UDP</option>
              <option value="icmp">ICMP</option>
            </select>
          </div>
          <div>
            <label>Service</label>
            <input type="text" class="service" placeholder="Service">
          </div>
          <div>
            <label>Port</label>
            <input type="number" class="port" placeholder="Port">
          </div>
          <div>
            <label>Authentication</label>
            <select class="authentication">
              <option value="none">Select</option>
              <option value="basic">Basic</option>
              <option value="oauth">OAuth</option>
            </select>
          </div>
          <div>
            <label>Flow encryption</label>
            <select class="encryption">
              <option value="none">Select</option>
              <option value="ssl">SSL/TLS</option>
              <option value="ipsec">IPSec</option>
            </select>
          </div>
          <div>
            <label>Classification</label>
            <select class="classification">
              <option value="public">Select</option>
              <option value="internal">Internal</option>
              <option value="confidential">Confidential</option>
            </select>
          </div>
          <div>
            <label>APP code</label>
            <input type="text" class="appCode" placeholder="Code (4 chars)" maxlength="4">
          </div>
          <button class="add-button" onclick="addNewRule()">+</button>
        </div>
      </div>

      <div class="action-buttons">
        <button class="btn btn-delete" onclick="deleteRules()">Delete</button>
        <button class="btn btn-resume" onclick="resumeDraft()">Resume Draft</button>
        <button class="btn btn-verify" onclick="verifyRules()">Verify</button>
        <button class="btn btn-validate" onclick="validateRules()">Validate</button>
        <button class="btn btn-generate" onclick="generateScripts()">Generate Scripts</button>
        <button class="btn btn-primary" onclick="saveDraftRules()">Save Draft</button>
      </div>

      <div id="output" class="output">
        <h3>Generated Scripts</h3>
        <div id="scripts-container"></div>
      </div>
    </div>

    <script>
      let ruleCount = 1;

      function validateIP(ip) {
        const ipPattern = /^(\d{1,3}\.){3}\d{1,3}$/;
        return ipPattern.test(ip);
      }

      function validatePort(port) {
        return port > 0 && port < 65536;
      }

      function addNewRule() {
        if (ruleCount >= 5) {
          alert('Maximum 5 rules allowed');
          return;
        }
        
        ruleCount++;
        const container = document.getElementById('rulesContainer');
        const newRule = document.querySelector('.rules-grid').cloneNode(true);
        newRule.id = 'rule-' + ruleCount;
        
        // Clear inputs in the new rule
        newRule.querySelectorAll('input').forEach(input => input.value = '');
        newRule.querySelectorAll('select').forEach(select => select.selectedIndex = 0);
        
        container.appendChild(newRule);
      }

      function generateScripts() {
        const mandatory = {
          department: document.getElementById('department').value,
          projectCode: document.getElementById('projectCode').value,
          email: document.getElementById('email').value
        };

        if (!mandatory.department || !mandatory.projectCode || !mandatory.email) {
          alert('Veuillez remplir tous les champs obligatoires');
          return;
        }

        const rules = [];
        document.querySelectorAll('.rules-grid').forEach((rule, index) => {
          const formData = {
            sourceIP: rule.querySelector('.sourceIP').value,
            destIP: rule.querySelector('.destIP').value,
            protocol: rule.querySelector('.protocol').value,
            service: rule.querySelector('.service').value,
            port: rule.querySelector('.port').value,
            authentication: rule.querySelector('.authentication').value,
            encryption: rule.querySelector('.encryption').value,
            classification: rule.querySelector('.classification').value,
            appCode: rule.querySelector('.appCode').value
          };

          if (formData.sourceIP && formData.destIP && formData.service && formData.port) {
            if (!validateIP(formData.sourceIP) || !validateIP(formData.destIP)) {
              alert(`Règle ${index + 1}: Format IP invalide`);
              return;
            }
            if (!validatePort(formData.port)) {
              alert(`Règle ${index + 1}: Port invalide`);
              return;
            }
            rules.push(formData);
          }
        });

        if (rules.length === 0) {
          alert('Aucune règle valide à générer');
          return;
        }

        const scriptsContainer = document.getElementById('scripts-container');
        scriptsContainer.innerHTML = '';

        rules.forEach((rule, index) => {
          google.script.run
            .withSuccessHandler(function(scriptContent) {
              const scriptDiv = document.createElement('div');
              scriptDiv.className = 'script-block';
              scriptDiv.innerHTML = `
                <div class="script-header">
                  <strong>ID: ${index + 1}</strong>
                  <button onclick="copyScript(this)" class="btn">Copy</button>
                </div>
                <textarea readonly class="script-output">${scriptContent}</textarea>
              `;
              scriptsContainer.appendChild(scriptDiv);

              // Save to sheet
              google.script.run.withSuccessHandler(function(response) {
                if (!response.success) {
                  alert('Erreur lors de la sauvegarde: ' + response.message);
                }
              }).saveToSheet({
                ...mandatory,
                script: scriptContent,
                rowIndex: index + 1
              });
            })
            .generateScript(rule);
        });

        document.getElementById('output').style.display = 'block';
      }

      function copyScript(button) {
        const textarea = button.parentElement.nextElementSibling;
        textarea.select();
        document.execCommand('copy');
        alert('Script copié dans le presse-papier');
      }

      function deleteRules() {
        if (confirm('Voulez-vous vraiment supprimer toutes les règles ?')) {
          const container = document.getElementById('rulesContainer');
          while (container.children.length > 1) {
            container.removeChild(container.lastChild);
          }
          document.querySelectorAll('input').forEach(input => input.value = '');
          document.querySelectorAll('select').forEach(select => select.selectedIndex = 0);
          document.getElementById('output').style.display = 'none';
          ruleCount = 1;
        }
      }

      function importCSVFile() {
        document.getElementById('csvFileInput').click();
      }

      function handleCSVFile(input) {
        const file = input.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            google.script.run
              .withSuccessHandler(function(response) {
                if (response.success) {
                  fillFormWithCSVData(response.rules);
                } else {
                  alert('Erreur lors de l\'importation: ' + response.message);
                }
              })
              .importCSV(e.target.result);
          };
          reader.readAsText(file);
        }
      }

      function fillFormWithCSVData(rules) {
        deleteRules();
        
        if (rules.length > 0) {
          const firstRule = rules[0];
          document.getElementById('department').value = firstRule.department;
          document.getElementById('projectCode').value = firstRule.projectCode;
          document.getElementById('email').value = firstRule.email;
          
          fillRuleInputs(document.querySelector('.rules-grid'), firstRule);
        }
        
        for (let i = 1; i < rules.length && i < 5; i++) {
          addNewRule();
          fillRuleInputs(document.querySelectorAll('.rules-grid')[i], rules[i]);
        }
      }

      function fillRuleInputs(ruleElement, ruleData) {
        ruleElement.querySelector('.sourceIP').value = ruleData.sourceIP;
        ruleElement.querySelector('.destIP').value = ruleData.destIP;
        ruleElement.querySelector('.protocol').value = ruleData.protocol;
        ruleElement.querySelector('.service').value = ruleData.service;
        ruleElement.querySelector('.port').value = ruleData.port;
        ruleElement.querySelector('.appCode').value = ruleData.appCode;
      }

      function saveDraftRules() {
        const rules = [];
        document.querySelectorAll('.rules-grid').forEach(rule => {
          const ruleData = {
            department: document.getElementById('department').value,
            projectCode: document.getElementById('projectCode').value,
            email: document.getElementById('email').value,
            sourceIP: rule.querySelector('.sourceIP').value,
            destIP: rule.querySelector('.destIP').value,
            protocol: rule.querySelector('.protocol').value,
            service: rule.querySelector('.service').value,
            port: rule.querySelector('.port').value,
            appCode: rule.querySelector('.appCode').value
          };
          if (ruleData.sourceIP && ruleData.destIP) {
            rules.push(ruleData);
          }
        });

        if (rules.length === 0) {
          alert('Aucune règle à sauvegarder');
          return;
        }

        google.script.run
          .withSuccessHandler(function(response) {
            if (response.success) {
              alert('Brouillon sauvegardé avec succès');
            } else {
              alert('Erreur lors de la sauvegarde: ' + response.message);
            }
          })
          .saveDraft(rules);
      }

      function resumeDraft() {
        google.script.run
          .withSuccessHandler(function(response) {
            if (response.success) {
              fillFormWithCSVData(response.data);
            } else {
              alert('Erreur lors de la récupération du brouillon: ' + response.message);
            }
          })
          .getDraftRules();
      }

      function verifyRules() {
        const rules = [];
        document.querySelectorAll('.rules-grid').forEach(rule => {
          const ruleData = {
            sourceIP: rule.querySelector('.sourceIP').value,
            destIP: rule.querySelector('.destIP').value,
            protocol: rule.querySelector('.protocol').value,
            service: rule.querySelector('.service').value,
            port: rule.querySelector('.port').value
          };
          if (ruleData.sourceIP && ruleData.destIP) {
            rules.push(ruleData);
          }
        });

        google.script.run
          .withSuccessHandler(function(results) {
            let message = '';
            results.forEach((result, index) => {
              if (!result.isValid) {
                message += `Règle ${index + 1}: ${result.errors.join(', ')}\n`;
              }
            });
            
            if (message) {
              alert('Erreurs détectées:\n' + message);
            } else {
              alert('Toutes les règles sont valides');
            }
          })
          .verifyRules(rules);
      }

      function validateRules() {
        const mandatory = {
          department: document.getElementById('department').value,
          projectCode: document.getElementById('projectCode').value,
          email: document.getElementById('email').value
        };

        if (!mandatory.department || !mandatory.projectCode || !mandatory.email) {
          alert('Veuillez remplir tous les champs obligatoires');
          return;
        }

        verifyRules();
      }
    </script>
  </body>
</html>
