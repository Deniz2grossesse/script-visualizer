
<script>
let rules = [];

function addRule() {
  const rule = {
    sourceIP: '',
    destIP: '',
    protocol: 'tcp',
    service: '',
    port: '',
    authentication: 'no',
    encryption: 'no',
    classification: 'yellow'
  };
  rules.push(rule);
  refreshRulesDisplay();
}

function createRuleElement(rule, index) {
  const ruleDiv = document.createElement('div');
  ruleDiv.className = 'rule';
  ruleDiv.innerHTML = `
    <div class="form-group">
      <label>Source IP</label>
      <input type="text" value="${rule.sourceIP}" onchange="updateRule(${index}, 'sourceIP', this.value)">
    </div>
    <div class="form-group">
      <label>Destination IP</label>
      <input type="text" value="${rule.destIP}" onchange="updateRule(${index}, 'destIP', this.value)">
    </div>
    <div class="form-group">
      <label>Protocol</label>
      <select onchange="updateRule(${index}, 'protocol', this.value)">
        <option value="tcp" ${rule.protocol === 'tcp' ? 'selected' : ''}>TCP</option>
        <option value="udp" ${rule.protocol === 'udp' ? 'selected' : ''}>UDP</option>
        <option value="icmp" ${rule.protocol === 'icmp' ? 'selected' : ''}>ICMP</option>
      </select>
    </div>
    <div class="form-group">
      <label>Service</label>
      <input type="text" value="${rule.service}" onchange="updateRule(${index}, 'service', this.value)">
    </div>
    <div class="form-group">
      <label>Port</label>
      <input type="number" min="1" max="65535" value="${rule.port}" onchange="updateRule(${index}, 'port', this.value)">
    </div>
  `;
  return ruleDiv;
}

function refreshRulesDisplay() {
  const container = document.getElementById('rulesContainer');
  container.innerHTML = '';
  rules.forEach((rule, index) => {
    container.appendChild(createRuleElement(rule, index));
  });
}

function updateRule(index, field, value) {
  rules[index][field] = value;
}

function verifyRules() {
  const department = document.getElementById('department').value;
  const projectCode = document.getElementById('projectCode').value;
  const email = document.getElementById('email').value;

  if (!department || !projectCode || !email) {
    alert('Veuillez remplir tous les champs obligatoires');
    return;
  }

  google.script.run
    .withSuccessHandler(function(results) {
      let hasErrors = false;
      results.forEach(result => {
        if (!result.isValid) {
          hasErrors = true;
          alert(`Erreur dans la règle ${result.ruleIndex + 1}: ${result.errors.join(', ')}`);
        }
      });
      if (!hasErrors) {
        alert('Toutes les règles sont valides');
      }
    })
    .withFailureHandler(function(error) {
      alert('Erreur lors de la vérification: ' + error);
    })
    .verifyRules(rules);
}

function generateScripts() {
  const department = document.getElementById('department').value;
  const projectCode = document.getElementById('projectCode').value;
  const email = document.getElementById('email').value;

  if (!department || !projectCode || !email) {
    alert('Veuillez remplir tous les champs obligatoires');
    return;
  }

  if (rules.length === 0) {
    alert('Veuillez ajouter au moins une règle');
    return;
  }

  const output = document.getElementById('output');
  output.innerHTML = '';
  output.style.display = 'block';

  rules.forEach((rule, index) => {
    const scriptData = { 
      ...rule,
      department,
      projectCode,
      email
    };

    google.script.run
      .withSuccessHandler(function(script) {
        const scriptBlock = document.createElement('div');
        scriptBlock.className = 'script-block';
        scriptBlock.innerHTML = `
          <div class="script-header">
            <span>Script ${index + 1}</span>
          </div>
          <textarea class="script-output" readonly>${script}</textarea>
        `;
        output.appendChild(scriptBlock);
      })
      .withFailureHandler(function(error) {
        alert('Erreur lors de la génération du script: ' + error);
      })
      .generateScript(scriptData);
  });
}

function saveDraft() {
  const department = document.getElementById('department').value;
  const projectCode = document.getElementById('projectCode').value;
  const email = document.getElementById('email').value;

  if (!department || !projectCode || !email) {
    alert('Veuillez remplir tous les champs obligatoires avant de sauvegarder');
    return;
  }

  const rulesWithMetadata = rules.map(rule => ({
    ...rule,
    department,
    projectCode,
    email
  }));

  google.script.run
    .withSuccessHandler(function(response) {
      if (response.success) {
        alert('Brouillon sauvegardé avec succès');
      } else {
        alert('Erreur lors de la sauvegarde: ' + response.message);
      }
    })
    .withFailureHandler(function(error) {
      alert('Erreur lors de la sauvegarde: ' + error);
    })
    .saveDraft(rulesWithMetadata);
}

function resumeDraft() {
  google.script.run
    .withSuccessHandler(function(response) {
      if (response.success && response.data.length > 0) {
        const lastRow = response.data[response.data.length - 1];
        document.getElementById('department').value = lastRow[0];
        document.getElementById('projectCode').value = lastRow[1];
        document.getElementById('email').value = lastRow[2];

        rules = response.data.map(row => ({
          sourceIP: row[3],
          destIP: row[4],
          protocol: row[5],
          service: row[6],
          port: row[7],
          appCode: row[8]
        }));

        refreshRulesDisplay();
      } else {
        alert('Aucun brouillon trouvé');
      }
    })
    .withFailureHandler(function(error) {
      alert('Erreur lors de la récupération du brouillon: ' + error);
    })
    .getDraftRules();
}

function deleteRules() {
  if (confirm('Êtes-vous sûr de vouloir supprimer toutes les règles ?')) {
    rules = [];
    refreshRulesDisplay();
    document.getElementById('output').style.display = 'none';
  }
}

// Ajouter une première règle au chargement
window.onload = addRule;
</script>
