<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="UTF-8">
    <title>Network Rules Generator</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background-color: #f5f5f5;
      }
      
      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }

      h1 {
        color: #333;
        margin-bottom: 20px;
      }

      .info-box {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 4px;
        color: #495057;
      }

      .mandatory {
        margin-bottom: 30px;
      }

      .form-group {
        margin-bottom: 15px;
      }

      label {
        display: block;
        margin-bottom: 5px;
        color: #495057;
      }

      .required {
        color: red;
      }

      input[type="text"],
      input[type="email"],
      input[type="number"],
      select {
        width: 100%;
        padding: 8px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        box-sizing: border-box;
        margin-bottom: 10px;
      }

      .rules-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
        padding: 15px;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        background-color: #f8f9fa;
      }

      .add-button {
        background-color: #28a745;
        color: white;
        border: none;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        font-size: 20px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-top: 10px;
      }

      .add-button:hover {
        background-color: #218838;
      }

      .action-buttons {
        margin-top: 20px;
        display: flex;
        gap: 10px;
      }

      .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: background-color 0.2s;
      }

      .btn-delete {
        background-color: #dc3545;
        color: white;
      }

      .btn-delete:hover {
        background-color: #c82333;
      }

      .btn-resume {
        background-color: #17a2b8;
        color: white;
      }

      .btn-resume:hover {
        background-color: #138496;
      }

      .btn-verify {
        background-color: #ffc107;
        color: #212529;
      }

      .btn-verify:hover {
        background-color: #e0a800;
      }

      .btn-validate {
        background-color: #28a745;
        color: white;
      }

      .btn-validate:hover {
        background-color: #218838;
      }

      .btn-generate {
        background-color: #007bff;
        color: white;
      }

      .btn-generate:hover {
        background-color: #0056b3;
      }

      .output {
        margin-top: 30px;
        display: none;
      }

      .script-block {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        margin-bottom: 15px;
        padding: 15px;
      }

      .script-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }

      .script-output {
        width: 100%;
        height: 150px;
        padding: 10px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        background-color: #fff;
        font-family: monospace;
        resize: vertical;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Network Rules Generator</h1>
      
      <div class="action-buttons" style="margin-bottom: 20px;">
        <button class="btn btn-primary" onclick="showFileInput()">Importer CSV</button>
        <input type="file" id="csvFileInput" accept=".csv" style="display: none;" onchange="handleFileSelect(event)">
      </div>
      
      <div class="info-box">
        Ces trois champs sont obligatoires, vous ne pouvez pas commencer à les saisir sans les avoir remplis.
      </div>

      <div class="mandatory">
        <div class="form-group">
          <label>Department <span class="required">*</span></label>
          <input type="text" id="department" placeholder="Department (1-4 chars)" maxlength="4">
        </div>
        <div class="form-group">
          <label>Project/Application Code <span class="required">*</span></label>
          <input type="text" id="projectCode" placeholder="Project code (1-4 chars)" maxlength="4">
        </div>
        <div class="form-group">
          <label>Requester's Email <span class="required">*</span></label>
          <input type="email" id="email" placeholder="Email address">
        </div>
      </div>

      <div id="rulesContainer">
        <div class="rules-grid" id="rule-1">
          <div>
            <label>Source IP</label>
            <input type="text" class="sourceIP" placeholder="IP source">
          </div>
          <div>
            <label>IP Destination</label>
            <input type="text" class="destIP" placeholder="IP destination">
          </div>
          <div>
            <label>Protocole</label>
            <select class="protocol">
              <option value="tcp">TCP</option>
              <option value="udp">UDP</option>
              <option value="icmp">ICMP</option>
            </select>
          </div>
          <div>
            <label>Service</label>
            <input type="text" class="service" placeholder="Service">
          </div>
          <div>
            <label>Port</label>
            <input type="number" class="port" placeholder="Port">
          </div>
          <div>
            <label>Authentication</label>
            <select class="authentication">
              <option value="none">Select</option>
              <option value="basic">Basic</option>
              <option value="oauth">OAuth</option>
            </select>
          </div>
          <div>
            <label>Flow encryption</label>
            <select class="encryption">
              <option value="none">Select</option>
              <option value="ssl">SSL/TLS</option>
              <option value="ipsec">IPSec</option>
            </select>
          </div>
          <div>
            <label>Classification</label>
            <select class="classification">
              <option value="public">Select</option>
              <option value="internal">Internal</option>
              <option value="confidential">Confidential</option>
            </select>
          </div>
          <div>
            <label>APP code</label>
            <input type="text" class="appCode" placeholder="Code (4 chars)" maxlength="4">
          </div>
          <button class="add-button" onclick="addNewRule()">+</button>
        </div>
      </div>

    <div class="action-buttons">
      <button class="btn btn-delete" onclick="handleDelete()">Delete</button>
      <button class="btn btn-resume" onclick="handleResumeDraft()">Resume Draft</button>
      <button class="btn btn-verify" onclick="handleVerify()">Verify</button>
      <button class="btn btn-validate" onclick="handleValidate()">Validate</button>
      <button class="btn btn-generate" onclick="handleGenerateScripts()">Generate Scripts</button>
      <button class="btn btn-primary" onclick="handleSaveDraft()">Save Draft</button>
    </div>

    <div id="output" class="output">
      <h3>Generated Scripts</h3>
      <div id="scripts-container"></div>
    </div>
  </div>

  <script>
    function showFileInput() {
      document.getElementById('csvFileInput').click();
    }

    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      
      reader.onload = function(e) {
        const content = e.target.result;
        google.script.run
          .withSuccessHandler(function(response) {
            if (response.success) {
              displayImportedRules(response.data);
            } else {
              alert('Erreur lors de l\'import: ' + response.message);
            }
          })
          .withFailureHandler(function(error) {
            alert('Erreur: ' + error.toString());
          })
          .importCSV(content);
      };
      
      reader.onerror = function() {
        alert('Erreur lors de la lecture du fichier');
      };

      reader.readAsText(file);
    }

    function displayImportedRules(rules) {
      const container = document.getElementById('rulesContainer');
      container.innerHTML = '';
      
      rules.forEach((rule, index) => {
        const ruleDiv = document.createElement('div');
        ruleDiv.className = 'rules-grid';
        ruleDiv.id = `rule-${index + 1}`;
        
        ruleDiv.innerHTML = `
          <div>
            <label>Source IP</label>
            <input type="text" class="sourceIP" value="${rule.sourceIP || ''}" placeholder="IP source">
          </div>
          <div>
            <label>IP Destination</label>
            <input type="text" class="destIP" value="${rule.destIP || ''}" placeholder="IP destination">
          </div>
          <div>
            <label>Protocole</label>
            <select class="protocol">
              <option value="tcp" ${rule.protocol === 'tcp' ? 'selected' : ''}>TCP</option>
              <option value="udp" ${rule.protocol === 'udp' ? 'selected' : ''}>UDP</option>
              <option value="icmp" ${rule.protocol === 'icmp' ? 'selected' : ''}>ICMP</option>
            </select>
          </div>
          <div>
            <label>Service</label>
            <input type="text" class="service" value="${rule.service || ''}" placeholder="Service">
          </div>
          <div>
            <label>Port</label>
            <input type="number" class="port" value="${rule.port || ''}" placeholder="Port">
          </div>
          <div>
            <label>Authentication</label>
            <select class="authentication">
              <option value="none" ${!rule.authentication ? 'selected' : ''}>Select</option>
              <option value="basic" ${rule.authentication === 'basic' ? 'selected' : ''}>Basic</option>
              <option value="oauth" ${rule.authentication === 'oauth' ? 'selected' : ''}>OAuth</option>
            </select>
          </div>
          <div>
            <label>Flow encryption</label>
            <select class="encryption">
              <option value="none" ${!rule.flowEncryption ? 'selected' : ''}>Select</option>
              <option value="ssl" ${rule.flowEncryption === 'ssl' ? 'selected' : ''}>SSL/TLS</option>
              <option value="ipsec" ${rule.flowEncryption === 'ipsec' ? 'selected' : ''}>IPSec</option>
            </select>
          </div>
          <div>
            <label>Classification</label>
            <select class="classification">
              <option value="public" ${!rule.classification ? 'selected' : ''}>Select</option>
              <option value="internal" ${rule.classification === 'internal' ? 'selected' : ''}>Internal</option>
              <option value="confidential" ${rule.classification === 'confidential' ? 'selected' : ''}>Confidential</option>
            </select>
          </div>
          <div>
            <label>APP code</label>
            <input type="text" class="appCode" value="${rule.appCode || ''}" placeholder="Code (4 chars)" maxlength="4">
          </div>
        `;
        
        container.appendChild(ruleDiv);
      });

      if (rules.length > 0) {
        document.getElementById('rulesContainer').style.display = 'block';
      }
    }

    function handleDelete() {
      if (confirm('Voulez-vous vraiment supprimer toutes les règles ?')) {
        document.getElementById('rulesContainer').innerHTML = '';
        document.getElementById('department').value = '';
        document.getElementById('projectCode').value = '';
        document.getElementById('email').value = '';
        document.getElementById('output').style.display = 'none';
      }
    }

    function handleResumeDraft() {
      google.script.run
        .withSuccessHandler(function(response) {
          if (response.success && response.data) {
            displayImportedRules(response.data);
          } else {
            alert('Aucun brouillon trouvé');
          }
        })
        .withFailureHandler(function(error) {
          alert('Erreur: ' + error.toString());
        })
        .getDraft();
    }

    function handleSaveDraft() {
      const rules = collectCurrentRules();
      google.script.run
        .withSuccessHandler(function(response) {
          if (response.success) {
            alert('Brouillon sauvegardé');
          } else {
            alert('Erreur lors de la sauvegarde: ' + response.message);
          }
        })
        .withFailureHandler(function(error) {
          alert('Erreur: ' + error.toString());
        })
        .saveDraft(rules);
    }

    function handleValidate() {
      const isValid = validateMandatoryFields();
      if (isValid) {
        handleVerify();
      }
    }

    function handleVerify() {
      const rules = collectCurrentRules();
      let isValid = true;
      let errors = [];

      rules.forEach((rule, index) => {
        if (!validateIP(rule.sourceIP)) {
          errors.push(`Règle ${index + 1}: IP source invalide`);
          isValid = false;
        }
        if (!validateIP(rule.destIP)) {
          errors.push(`Règle ${index + 1}: IP destination invalide`);
          isValid = false;
        }
        if (!validatePort(rule.port)) {
          errors.push(`Règle ${index + 1}: Port invalide`);
          isValid = false;
        }
      });

      if (!isValid) {
        alert('Erreurs détectées:\n' + errors.join('\n'));
      } else {
        alert('Toutes les règles sont valides');
      }
    }

    function handleGenerateScripts() {
      if (!validateMandatoryFields()) {
        return;
      }

      const rules = collectCurrentRules();
      if (rules.length === 0) {
        alert('Aucune règle à générer');
        return;
      }

      const formData = {
        department: document.getElementById('department').value,
        projectCode: document.getElementById('projectCode').value,
        email: document.getElementById('email').value,
        rules: rules
      };

      google.script.run
        .withSuccessHandler(function(response) {
          if (response.success) {
            displayGeneratedScripts(response.data);
          } else {
            alert('Erreur: ' + response.message);
          }
        })
        .withFailureHandler(function(error) {
          alert('Erreur: ' + error.toString());
        })
        .generateScripts(formData);
    }

    function validateMandatoryFields() {
      const department = document.getElementById('department').value;
      const projectCode = document.getElementById('projectCode').value;
      const email = document.getElementById('email').value;

      if (!department || !projectCode || !email) {
        alert('Veuillez remplir tous les champs obligatoires (département, code projet et email)');
        return false;
      }
      return true;
    }

    function validateIP(ip) {
      const ipPattern = /^(\d{1,3}\.){3}\d{1,3}$/;
      return ipPattern.test(ip);
    }

    function validatePort(port) {
      return port > 0 && port < 65536;
    }

    function collectCurrentRules() {
      const rules = [];
      document.querySelectorAll('.rules-grid').forEach(grid => {
        const rule = {
          sourceIP: grid.querySelector('.sourceIP').value,
          destIP: grid.querySelector('.destIP').value,
          protocol: grid.querySelector('.protocol').value,
          service: grid.querySelector('.service').value,
          port: grid.querySelector('.port').value,
          authentication: grid.querySelector('.authentication').value,
          encryption: grid.querySelector('.encryption').value,
          classification: grid.querySelector('.classification').value,
          appCode: grid.querySelector('.appCode').value
        };
        if (rule.sourceIP && rule.destIP) {
          rules.push(rule);
        }
      });
      return rules;
    }

    function displayGeneratedScripts(scripts) {
      const container = document.getElementById('scripts-container');
      container.innerHTML = '';
      
      Object.entries(scripts).forEach(([type, script]) => {
        const scriptBlock = document.createElement('div');
        scriptBlock.className = 'script-block';
        scriptBlock.innerHTML = `
          <div class="script-header">
            <strong>${type}</strong>
            <button onclick="copyScript(this)" class="btn">Copy</button>
          </div>
          <textarea readonly class="script-output">${script}</textarea>
        `;
        container.appendChild(scriptBlock);
      });

      document.getElementById('output').style.display = 'block';
    }

    function copyScript(button) {
      const textarea = button.parentElement.nextElementSibling;
      textarea.select();
      document.execCommand('copy');
      alert('Script copié dans le presse-papier');
    }
  </script>
</body>
</html>
